<% content_for :title, "æœ¬ã‚’è¿½åŠ  - ã‚³ãƒ¼ãƒ’ãƒ¼ã¨æœ¬ã¨çŒ«" %>

<div class="add-book-page">
    <div class="back-navigation">
        <%= link_to books_path, class: "back-button" do %>
        <span class="back-icon">â†</span>
        æˆ»ã‚‹
        <% end %>
    </div>

    <div class="add-book-header">
        <h1 class="add-book-title">æ–°ã—ã„æœ¬ã‚’è¿½åŠ </h1>
        <p class="add-book-subtitle">èª­ã¿çµ‚ã‚ã£ãŸæœ¬ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†</p>
    </div>

    <div class="search-books-section">
        <div class="search-books-card">
            <h2 class="search-books-title">
                <span class="search-icon">ğŸ”</span>
                æœ¬ã‚’æ¤œç´¢
            </h2>

            <div class="search-tips">
                <p class="tips-title">ğŸ’¡ æ¤œç´¢ã®ã‚³ãƒ„:</p>
                <ul class="tips-list">
                    <li>ã€Œ"ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼"ã€ã®ã‚ˆã†ã«å¼•ç”¨ç¬¦ã§å›²ã‚€ã¨å®Œå…¨ä¸€è‡´æ¤œç´¢</li>
                    <li>ã€Œæ‘ä¸Šæ˜¥æ¨¹ ãƒãƒ«ã‚¦ã‚§ã‚¤ã€ã®ã‚ˆã†ã«è‘—è€…åã¨ä½œå“åã‚’çµ„ã¿åˆã‚ã›ã‚‹</li>
                    <li>ã€ŒRuby ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ã®ã‚ˆã†ã«ã‚¸ãƒ£ãƒ³ãƒ«ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã‚‹</li>
                </ul>
            </div>

            <div class="search-form">
                <input type="text" id="search-input" placeholder="ä¾‹: &quot;ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼&quot;ã€æ‘ä¸Šæ˜¥æ¨¹ã€Ruby ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°" class="search-input">
                <button onclick="safeSearch(1)" class="search-button">
                    <span class="button-icon">ğŸ”</span>
                    æ¤œç´¢
                </button>
            </div>

            <div class="search-examples">
                <p class="examples-title">äººæ°—ã®æ¤œç´¢ä¾‹:</p>
                <div class="examples-buttons">
                    <button onclick="searchExample('&quot;ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼&quot;')" class="example-button">ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼</button>
                    <button onclick="searchExample('æ‘ä¸Šæ˜¥æ¨¹')" class="example-button">æ‘ä¸Šæ˜¥æ¨¹</button>
                    <button onclick="searchExample('&quot;é¬¼æ»…ã®åˆƒ&quot;')" class="example-button">é¬¼æ»…ã®åˆƒ</button>
                    <button onclick="searchExample('Python ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°')" class="example-button">Pythonå…¥é–€</button>
                    <button onclick="searchExample('æ±é‡åœ­å¾')" class="example-button">æ±é‡åœ­å¾</button>
                </div>
            </div>

            <div class="search-results-container">
                <div id="search-results" class="search-results"></div>
                <div id="search-pagination" class="search-pagination"></div>
                <div id="pagination-info" class="pagination-info"></div>
            </div>
        </div>
    </div>

    <div class="manual-form-section">
        <div class="manual-form-card">
            <h2 class="manual-form-title">
                <span class="form-icon">âœï¸</span>
                æ‰‹å‹•ã§å…¥åŠ›
            </h2>

            <%= form_with model: @book, local: true, class: "book-form" do |form| %>
            <% if @book.errors.any? %>
            <div class="error-card">
                <div class="error-header">
                    <span class="error-icon">ğŸš«</span>
                    <span class="error-title">å…¥åŠ›å†…å®¹ã‚’ã”ç¢ºèªãã ã•ã„</span>
                </div>
                <ul class="error-list">
                    <% @book.errors.full_messages.each do |message| %>
                    <li class="error-item"><%= message %></li>
                    <% end %>
                </ul>
            </div>
            <% end %>

            <div class="form-group">
                <%= form.label :title, "ã‚¿ã‚¤ãƒˆãƒ«", class: "form-label" %>
                <%= form.text_field :title, required: true, class: "form-input", placeholder: "æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›" %>
            </div>

            <div class="form-group">
                <%= form.label :author, "è‘—è€…", class: "form-label" %>
                <%= form.text_field :author, class: "form-input", placeholder: "è‘—è€…åã‚’å…¥åŠ›" %>
            </div>

            <div class="form-group">
                <%= form.label :publisher, "å‡ºç‰ˆç¤¾", class: "form-label" %>
                <%= form.text_field :publisher, class: "form-input", placeholder: "å‡ºç‰ˆç¤¾åã‚’å…¥åŠ›" %>
            </div>

            <div class="form-group">
                <%= form.label :cover_image_url, "è¡¨ç´™ç”»åƒURL", class: "form-label" %>
                <%= form.url_field :cover_image_url, class: "form-input", placeholder: "https://..." %>
                <% if @book.cover_image_url.present? %>
                <div class="current-image">
                    <p class="current-image-label">ç¾åœ¨ã®ç”»åƒ:</p>
                    <img src="<%= @book.cover_image_url %>" alt="<%= @book.title %>" class="current-image-preview">
                </div>
                <% end %>
            </div>

            <div class="form-group">
                <%= form.label :rating, "è©•ä¾¡", class: "form-label" %>
                <%= form.select :rating, options_for_select([
                            ['æœªè©•ä¾¡', nil],
                            ['â˜…â˜†â˜†â˜†â˜† (1)', 1],
                            ['â˜…â˜…â˜†â˜†â˜† (2)', 2],
                            ['â˜…â˜…â˜…â˜†â˜† (3)', 3],
                            ['â˜…â˜…â˜…â˜…â˜† (4)', 4],
                            ['â˜…â˜…â˜…â˜…â˜… (5)', 5]
                        ]), {}, { class: "form-select" } %>
            </div>

            <div class="form-group">
                <%= form.label :memo, "ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³", class: "form-label" %>
                <%= form.text_area :memo, rows: 6, placeholder: "èª­ã‚“ã æ„Ÿæƒ³ã‚„å°è±¡ã«æ®‹ã£ãŸéƒ¨åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†...", class: "form-textarea" %>
            </div>

            <div class="form-actions">
                <%= form.submit "ä¿å­˜", class: "submit-button primary" %>
                <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", books_path, class: "submit-button secondary" %>
            </div>
            <% end %>
        </div>
    </div>
</div>

<script>
    (function() {
        'use strict';

        function initializeBookSearch() {
            window.BookSearch = {
                currentQuery: '',
                currentPage: 1,
                totalPages: 0,
                validPages: new Set(),
                isLoading: false,
                initialized: true,

                async search(page = 1) {
                    const query = document.getElementById('search-input').value.trim();
                    const resultsDiv = document.getElementById('search-results');
                    const paginationDiv = document.getElementById('search-pagination');
                    const paginationInfo = document.getElementById('pagination-info');

                    if (!query) {
                        resultsDiv.innerHTML = '<div class="search-empty"><div class="empty-icon">ğŸ”</div><p>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>';
                        paginationDiv.style.display = 'none';
                        paginationInfo.style.display = 'none';
                        return;
                    }

                    if (this.isLoading) return;

                    if (this.currentQuery !== query) {
                        this.validPages.clear();
                        this.totalPages = 0;
                    }

                    this.isLoading = true;
                    this.currentQuery = query;
                    this.currentPage = page;

                    const startIndex = (page - 1) * 10;

                    resultsDiv.innerHTML = '<div class="search-loading"><div class="loading-spinner"></div><p>æ¤œç´¢ä¸­...</p></div>';
                    paginationDiv.style.display = 'none';
                    paginationInfo.style.display = 'none';

                    try {
                        const response = await fetch(`/books/search_external?query=${encodeURIComponent(query)}&start_index=${startIndex}`);

                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();

                        if (data.error) {
                            throw new Error(data.error);
                        }

                        this.totalPages = Math.max(this.totalPages, data.pagination.total_pages);

                        if (data.items.length > 0) {
                            this.validPages.add(page);
                            this.displayResults(data.items);
                            this.displayPagination(data.pagination);
                            this.displayPaginationInfo(data.pagination);
                        } else {
                            if (page === 1) {
                                resultsDiv.innerHTML = '<div class="search-empty"><div class="empty-icon">ğŸ“š</div><p>æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p></div>';
                                paginationDiv.style.display = 'none';
                                paginationInfo.style.display = 'none';
                            } else {
                                const lastValidPage = Math.max(...Array.from(this.validPages));
                                if (lastValidPage && lastValidPage < page) {
                                    this.search(lastValidPage);
                                    return;
                                } else {
                                    resultsDiv.innerHTML = '<div class="search-empty"><div class="empty-icon">ğŸ“š</div><p>ã“ã‚Œä»¥ä¸Šã®çµæœã¯ã‚ã‚Šã¾ã›ã‚“</p></div>';
                                    this.totalPages = Math.max(...Array.from(this.validPages));
                                    const correctedPagination = {
                                        ...data.pagination,
                                        total_pages: this.totalPages,
                                        current_page: page,
                                        has_next: false
                                    };
                                    this.displayPagination(correctedPagination);
                                    this.displayPaginationInfo(correctedPagination);
                                }
                            }
                        }

                    } catch (error) {
                        resultsDiv.innerHTML = `<div class="search-error"><div class="error-icon">âš ï¸</div><p>æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p></div>`;
                        paginationDiv.style.display = 'none';
                        paginationInfo.style.display = 'none';
                    } finally {
                        this.isLoading = false;
                    }
                },

                displayResults(books) {
                    const resultsDiv = document.getElementById('search-results');
                    if (books.length === 0) return;

                    let html = '';
                    const currentTime = Date.now();

                    books.forEach((book, index) => {
                        const hasValidImage = book.cover_image && book.cover_image !== '' && book.cover_image !== 'null';
                        const bookId = `book-${index}-${currentTime}`;

                        html += `
                            <div class="search-result-card" onclick="window.BookSearch.selectBook('${this.escapeHtml(book.title)}', '${this.escapeHtml(book.authors)}', '${this.escapeHtml(book.publisher)}', '${this.escapeHtml(book.cover_image || '')}')">
                                <div class="result-cover" id="cover-${bookId}">
                                    ${hasValidImage ? 
                                        `<div class="image-container">
                                            <img id="img-${bookId}"
                                                 src="${book.cover_image}" 
                                                 alt="${this.escapeHtml(book.title)}" 
                                                 class="result-image"
                                                 onload="window.BookSearch.handleImageLoad('${bookId}')"
                                                 onerror="window.BookSearch.handleImageError('${bookId}', '${this.escapeHtml(book.title)}')">
                                            <div id="fallback-${bookId}" class="result-fallback">
                                                <span class="fallback-icon">ğŸ“–</span>
                                                <span class="fallback-text">ç”»åƒãªã—</span>
                                            </div>
                                            <div id="loading-${bookId}" class="result-loading">
                                                <div class="loading-mini"></div>
                                                <span class="loading-text">èª­è¾¼ä¸­</span>
                                            </div>
                                        </div>` : 
                                        `<div class="result-placeholder">
                                            <span class="placeholder-icon">ğŸ“–</span>
                                            <span class="placeholder-text">ç”»åƒãªã—</span>
                                        </div>`
                                    }
                                </div>
                                <div class="result-info">
                                    <h3 class="result-title">${this.escapeHtml(book.title)}</h3>
                                    <p class="result-author">è‘—è€…: ${this.escapeHtml(book.authors)}</p>
                                    <p class="result-publisher">å‡ºç‰ˆç¤¾: ${this.escapeHtml(book.publisher)}</p>
                                </div>
                            </div>
                        `;
                    });

                    resultsDiv.innerHTML = html;
                    this.manageImageLoading(books, currentTime);
                },

                displayPagination(pagination) {
                    const paginationDiv = document.getElementById('search-pagination');
                    const currentPage = pagination.current_page;
                    const maxValidPage = this.validPages.size > 0 ? Math.max(...Array.from(this.validPages)) : 1;
                    const displayTotalPages = Math.max(maxValidPage, this.totalPages);

                    if (displayTotalPages <= 1) {
                        paginationDiv.style.display = 'none';
                        return;
                    }

                    let html = '';

                    if (pagination.has_prev && currentPage > 1) {
                        html += `<button class="pagination-button prev" onclick="safeSearch(${currentPage - 1})">å‰ã¸</button>`;
                    } else {
                        html += `<button class="pagination-button prev disabled">å‰ã¸</button>`;
                    }

                    let startPage, endPage;
                    if (displayTotalPages <= 10) {
                        startPage = 1;
                        endPage = displayTotalPages;
                    } else {
                        if (currentPage <= 5) {
                            startPage = 1;
                            endPage = 8;
                        } else if (currentPage >= displayTotalPages - 4) {
                            startPage = displayTotalPages - 7;
                            endPage = displayTotalPages;
                        } else {
                            startPage = currentPage - 3;
                            endPage = currentPage + 4;
                        }
                    }

                    if (startPage > 1) {
                        html += `<button class="pagination-button" onclick="safeSearch(1)">1</button>`;
                        if (startPage > 2) {
                            html += `<span class="pagination-ellipsis">...</span>`;
                        }
                    }

                    for (let i = startPage; i <= endPage; i++) {
                        if (i === currentPage) {
                            html += `<button class="pagination-button active">${i}</button>`;
                        } else if (i <= maxValidPage) {
                            html += `<button class="pagination-button" onclick="safeSearch(${i})">${i}</button>`;
                        } else if (i === maxValidPage + 1 && pagination.has_next) {
                            html += `<button class="pagination-button" onclick="safeSearch(${i})">${i}</button>`;
                        }
                    }

                    if (endPage < displayTotalPages && displayTotalPages <= maxValidPage + 1) {
                        if (endPage < displayTotalPages - 1) {
                            html += `<span class="pagination-ellipsis">...</span>`;
                        }
                        html += `<button class="pagination-button" onclick="safeSearch(${displayTotalPages})">${displayTotalPages}</button>`;
                    }

                    if (pagination.has_next || currentPage < maxValidPage + 1) {
                        html += `<button class="pagination-button next" onclick="safeSearch(${currentPage + 1})">æ¬¡ã¸</button>`;
                    } else {
                        html += `<button class="pagination-button next disabled">æ¬¡ã¸</button>`;
                    }

                    paginationDiv.innerHTML = html;
                    paginationDiv.style.display = 'flex';
                },

                displayPaginationInfo(pagination) {
                    const paginationInfo = document.getElementById('pagination-info');

                    if (pagination.total_items === 0) {
                        paginationInfo.style.display = 'none';
                        return;
                    }

                    const startItem = pagination.start_index + 1;
                    const endItem = Math.min(pagination.start_index + 10, pagination.total_items);
                    const maxValidPage = this.validPages.size > 0 ? Math.max(...Array.from(this.validPages)) : 1;

                    let infoText = `${startItem}ã€œ${endItem}ä»¶ / å…¨${pagination.total_items}ä»¶ (${pagination.current_page}/${maxValidPage}+ãƒšãƒ¼ã‚¸)`;

                    if (pagination.total_items >= 1000) {
                        infoText += ` â€»æœ€å¤§1000ä»¶ã¾ã§è¡¨ç¤º`;
                    }

                    paginationInfo.innerHTML = infoText;
                    paginationInfo.style.display = 'block';
                },

                manageImageLoading(books, currentTime) {
                    books.forEach((book, index) => {
                        if (book.cover_image && book.cover_image !== '') {
                            const bookId = `book-${index}-${currentTime}`;

                            setTimeout(() => {
                                const img = document.getElementById(`img-${bookId}`);
                                const loading = document.getElementById(`loading-${bookId}`);

                                if (img && !img.complete) {
                                    this.handleImageError(bookId, book.title);
                                } else if (loading && loading.style.display !== 'none') {
                                    this.handleImageError(bookId, book.title);
                                }
                            }, 2000);
                        }
                    });
                },

                handleImageLoad(bookId) {
                    const loading = document.getElementById(`loading-${bookId}`);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                },

                handleImageError(bookId, bookTitle) {
                    const img = document.getElementById(`img-${bookId}`);
                    const fallback = document.getElementById(`fallback-${bookId}`);
                    const loading = document.getElementById(`loading-${bookId}`);

                    if (img) img.style.display = 'none';
                    if (loading) loading.style.display = 'none';
                    if (fallback) fallback.style.display = 'flex';
                },

                selectBook(title, authors, publisher, coverImage) {
                    document.getElementById('book_title').value = title;
                    document.getElementById('book_author').value = authors;
                    document.getElementById('book_publisher').value = publisher;
                    document.getElementById('book_cover_image_url').value = coverImage;

                    document.getElementById('book_title').scrollIntoView({
                        behavior: 'smooth'
                    });

                    const selectedMessage = document.createElement('div');
                    selectedMessage.innerHTML = 'âœ… æœ¬ãŒé¸æŠã•ã‚Œã¾ã—ãŸ';
                    selectedMessage.className = 'selection-message';
                    document.body.appendChild(selectedMessage);

                    setTimeout(() => {
                        selectedMessage.remove();
                    }, 3000);
                },

                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            };
        }

        window.safeSearch = function(page = 1) {
            if (window.BookSearch && window.BookSearch.initialized) {
                window.BookSearch.search(page);
            } else {
                setTimeout(() => {
                    if (window.BookSearch && window.BookSearch.initialized) {
                        window.BookSearch.search(page);
                    }
                }, 100);
            }
        };

        window.searchExample = function(exampleQuery) {
            const searchInput = document.getElementById('search-input');
            searchInput.value = exampleQuery;
            safeSearch(1);
        };

        function initialize() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeBookSearch);
            } else {
                initializeBookSearch();
            }
        }

        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        safeSearch(1);
                    }
                });

                searchInput.addEventListener('input', function(e) {
                    if (e.target.value.trim() === '') {
                        const resultsDiv = document.getElementById('search-results');
                        const paginationDiv = document.getElementById('search-pagination');
                        const paginationInfo = document.getElementById('pagination-info');

                        if (resultsDiv) resultsDiv.innerHTML = '';
                        if (paginationDiv) paginationDiv.style.display = 'none';
                        if (paginationInfo) paginationInfo.style.display = 'none';
                    }
                });
            } else {
                setTimeout(setupEventListeners, 100);
            }
        }

        initialize();
        setupEventListeners();

    })();
</script>