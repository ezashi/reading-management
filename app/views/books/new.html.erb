<% content_for :title, "本を追加" %>

<div class="form-container">
    <!-- 戻るボタン -->
    <div style="margin-bottom: 1rem;">
        <%= link_to books_path, class: "btn btn-secondary" do %>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        戻る
        <% end %>
    </div>

    <h1 class="form-title">本を追加</h1>

    <!-- 外部検索セクション -->
    <div class="external-search">
        <h2 class="external-search-title">本を検索</h2>
        <div class="external-search-form">
            <input type="text" id="search-input" placeholder="タイトル、著者を入力して検索" class="external-search-input">
            <button onclick="searchBooks()" class="btn btn-primary">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                検索
            </button>
        </div>
        <div id="search-results" class="search-results"></div>
    </div>

    <!-- 手動入力フォーム -->
    <div style="background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e5e7eb;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #1f2937;">手動で入力</h2>

        <%= form_with model: @book, local: true do |form| %>
        <% if @book.errors.any? %>
        <div class="error-messages">
            <ul>
                <% @book.errors.full_messages.each do |message| %>
                <li><%= message %></li>
                <% end %>
            </ul>
        </div>
        <% end %>

        <div class="form-group">
            <%= form.label :title, "タイトル", class: "form-label" %>
            <%= form.text_field :title, required: true, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :author, "著者", class: "form-label" %>
            <%= form.text_field :author, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :publisher, "出版社", class: "form-label" %>
            <%= form.text_field :publisher, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :cover_image_url, "表紙画像URL", class: "form-label" %>
            <%= form.url_field :cover_image_url, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :rating, "評価", class: "form-label" %>
            <%= form.select :rating, options_for_select([
                    ['未評価', nil],
                    ['★☆☆☆☆ (1)', 1],
                    ['★★☆☆☆ (2)', 2],
                    ['★★★☆☆ (3)', 3],
                    ['★★★★☆ (4)', 4],
                    ['★★★★★ (5)', 5]
                ]), {}, { class: "form-select" } %>
        </div>

        <div class="form-group">
            <%= form.label :memo, "メモ・感想", class: "form-label" %>
            <%= form.text_area :memo, rows: 6, placeholder: "読んだ感想や印象に残った部分を記録しましょう...", class: "form-textarea" %>
        </div>

        <div class="form-actions">
            <%= form.submit "保存", class: "btn btn-primary" %>
            <%= link_to "キャンセル", books_path, class: "btn btn-secondary" %>
        </div>
        <% end %>
    </div>
</div>

<script>
    async function searchBooks() {
        const query = document.getElementById('search-input').value.trim();
        const resultsDiv = document.getElementById('search-results');

        if (!query) {
            resultsDiv.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">検索キーワードを入力してください</p>';
            return;
        }

        resultsDiv.innerHTML = '<div class="loading"><div class="loading-spinner"></div>検索中...</div>';

        try {
            const response = await fetch(`/books/search_external?query=${encodeURIComponent(query)}`);
            const books = await response.json();

            if (books.length === 0) {
                resultsDiv.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 1rem;">検索結果が見つかりませんでした</p>';
                return;
            }

            let html = '';
            books.forEach(book => {
                html += `
                    <div class="search-result" onclick="selectBook('${book.title.replace(/'/g, "\\'")}', '${book.authors.replace(/'/g, "\\'")}', '${book.publisher.replace(/'/g, "\\'")}', '${book.cover_image}')">
                        <div class="search-result-content">
                            <div class="search-result-cover">
                                ${book.cover_image ? `<img src="${book.cover_image}" alt="${book.title}">` : '📖'}
                            </div>
                            <div class="search-result-info">
                                <h3 class="search-result-title">${book.title}</h3>
                                <p class="search-result-author">著者: ${book.authors}</p>
                                <p class="search-result-publisher">出版社: ${book.publisher}</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        } catch (error) {
            resultsDiv.innerHTML = '<p style="color: #dc2626; text-align: center; padding: 1rem;">検索中にエラーが発生しました</p>';
        }
    }

    function selectBook(title, authors, publisher, coverImage) {
        document.getElementById('book_title').value = title;
        document.getElementById('book_author').value = authors;
        document.getElementById('book_publisher').value = publisher;
        document.getElementById('book_cover_image_url').value = coverImage;

        // スクロールしてフォームを表示
        document.getElementById('book_title').scrollIntoView({
            behavior: 'smooth'
        });
    }

    // Enterキーで検索
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBooks();
        }
    });
</script>