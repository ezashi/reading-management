<% content_for :title, "æœ¬ã‚’è¿½åŠ " %>

<div>
    <div>
        <%= link_to "â† æˆ»ã‚‹", books_path %>
        <h1>æœ¬ã‚’è¿½åŠ </h1>
    </div>

    <!-- å¤–éƒ¨æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div>
        <h2>æœ¬ã‚’æ¤œç´¢</h2>
        <div>
            <input type="text" id="search-input" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ã€è‘—è€…ã‚’å…¥åŠ›ã—ã¦æ¤œç´¢">
            <button onclick="searchBooks()">
                æ¤œç´¢
            </button>
        </div>

        <div id="search-results"></div>
    </div>

    <!-- æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div>
        <h2>æ‰‹å‹•ã§å…¥åŠ›</h2>

        <%= form_with model: @book, local: true do |form| %>
        <% if @book.errors.any? %>
        <div>
            <ul>
                <% @book.errors.full_messages.each do |message| %>
                <li><%= message %></li>
                <% end %>
            </ul>
        </div>
        <% end %>

        <div>
            <%= form.label :title, "ã‚¿ã‚¤ãƒˆãƒ«" %>
            <%= form.text_field :title, required: true %>
        </div>

        <div>
            <%= form.label :author, "è‘—è€…" %>
            <%= form.text_field :author %>
        </div>

        <div>
            <%= form.label :publisher, "å‡ºç‰ˆç¤¾" %>
            <%= form.text_field :publisher %>
        </div>

        <div>
            <%= form.label :cover_image_url, "è¡¨ç´™ç”»åƒURL" %>
            <%= form.url_field :cover_image_url %>
        </div>

        <div>
            <%= form.label :rating, "è©•ä¾¡" %>
            <%= form.select :rating, options_for_select([
              ['æœªè©•ä¾¡', nil],
              ['â˜…â˜†â˜†â˜†â˜† (1)', 1],
              ['â˜…â˜…â˜†â˜†â˜† (2)', 2],
              ['â˜…â˜…â˜…â˜†â˜† (3)', 3],
              ['â˜…â˜…â˜…â˜…â˜† (4)', 4],
              ['â˜…â˜…â˜…â˜…â˜… (5)', 5]
        ]) %>
        </div>

        <div>
            <%= form.label :memo, "ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³" %>
            <%= form.text_area :memo, rows: 4, placeholder: "èª­ã‚“ã æ„Ÿæƒ³ã‚„å°è±¡ã«æ®‹ã£ãŸéƒ¨åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†..." %>
        </div>

        <div>
            <%= form.submit "ä¿å­˜" %>
            <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", books_path %>
        </div>
        <% end %>
    </div>
</div>

<script>
    async function searchBooks() {
        const query = document.getElementById('search-input').value.trim();
        const resultsDiv = document.getElementById('search-results');

        if (!query) {
            resultsDiv.innerHTML = '<p>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>';
            return;
        }

        resultsDiv.innerHTML = '<p>æ¤œç´¢ä¸­...</p>';

        try {
            const response = await fetch(`/books/search_external?query=${encodeURIComponent(query)}`);
            const books = await response.json();

            if (books.length === 0) {
                resultsDiv.innerHTML = '<p>æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p>';
                return;
            }

            let html = '<div>';
            books.forEach(book => {
                html += `
        <div onclick="selectBook('${book.title}', '${book.authors}', '${book.publisher}', '${book.cover_image}')">
          <div>
            <div>
              ${book.cover_image ? `<img src="${book.cover_image}" alt="${book.title}">` : 'ğŸ“–'}
            </div>
            <div>
              <h3>${book.title}</h3>
              <p>è‘—è€…: ${book.authors}</p>
              <p>å‡ºç‰ˆç¤¾: ${book.publisher}</p>
            </div>
          </div>
        </div>
      `;
            });
            html += '</div>';

            resultsDiv.innerHTML = html;
        } catch (error) {
            resultsDiv.innerHTML = '<p>æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>';
        }
    }

    function selectBook(title, authors, publisher, coverImage) {
        document.getElementById('book_title').value = title;
        document.getElementById('book_author').value = authors;
        document.getElementById('book_publisher').value = publisher;
        document.getElementById('book_cover_image_url').value = coverImage;

        // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
        document.getElementById('book_title').scrollIntoView({
            behavior: 'smooth'
        });
    }

    // Enterã‚­ãƒ¼ã§æ¤œç´¢
    document.getElementById('search-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchBooks();
        }
    });
</script>