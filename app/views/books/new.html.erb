<% content_for :title, "æœ¬ã‚’è¿½åŠ " %>

<div class="add-book-container">
    <div class="back-navigation">
        <%= link_to books_path, class: "back-button" do %>
        â† æˆ»ã‚‹
        <% end %>
    </div>

    <h1 class="page-title">æ–°ã—ã„æœ¬ã‚’è¿½åŠ </h1>

    <div class="search-section">
        <div class="search-card">
            <h2 class="section-title">æœ¬ã‚’æ¤œç´¢</h2>

            <div class="search-tips">
                <p class="tips-title">æ¤œç´¢ã®ã‚³ãƒ„:</p>
                <ul>
                    <li>ã€Œ"ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼"ã€ã®ã‚ˆã†ã«å¼•ç”¨ç¬¦ã§å›²ã‚€ã¨å®Œå…¨ä¸€è‡´æ¤œç´¢</li>
                    <li>ã€Œæ‘ä¸Šæ˜¥æ¨¹ ãƒãƒ«ã‚¦ã‚§ã‚¤ã€ã®ã‚ˆã†ã«è‘—è€…åã¨ä½œå“åã‚’çµ„ã¿åˆã‚ã›ã‚‹</li>
                    <li>ã€ŒRuby ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ã®ã‚ˆã†ã«ã‚¸ãƒ£ãƒ³ãƒ«ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã‚‹</li>
                </ul>
            </div>

            <div class="search-form">
                <input type="text" id="search-input" placeholder="æœ¬ã®ã‚¿ã‚¤ãƒˆãƒ«ã€è‘—è€…åç­‰ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" class="search-input">
                <button onclick="BookSearch.search(1)" class="search-button">æ¤œç´¢</button>
            </div>

            <div class="search-examples">
                <p>äººæ°—ã®æ¤œç´¢ä¾‹:</p>
                <div class="example-buttons">
                    <button onclick="BookSearch.searchExample('ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼')" class="example-button">ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼</button>
                    <button onclick="BookSearch.searchExample('æ‘ä¸Šæ˜¥æ¨¹')" class="example-button">æ‘ä¸Šæ˜¥æ¨¹</button>
                    <button onclick="BookSearch.searchExample('é¬¼æ»…ã®åˆƒ')" class="example-button">é¬¼æ»…ã®åˆƒ</button>
                    <button onclick="BookSearch.searchExample('Python ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°')" class="example-button">Pythonå…¥é–€</button>
                </div>
            </div>

            <div id="search-results" class="search-results"></div>
            <div id="search-pagination" class="search-pagination"></div>
            <div id="pagination-info" class="pagination-info"></div>
        </div>
    </div>

    <div class="manual-section">
        <div class="manual-card">
            <h2 class="section-title">æ‰‹å‹•ã§å…¥åŠ›</h2>

            <%= form_with model: @book, local: true, class: "book-form" do |form| %>
            <% if @book.errors.any? %>
            <div class="error-messages">
                <ul>
                    <% @book.errors.full_messages.each do |message| %>
                    <li><%= message %></li>
                    <% end %>
                </ul>
            </div>
            <% end %>

            <div class="form-group">
                <%= form.label :title, "ã‚¿ã‚¤ãƒˆãƒ«", class: "form-label" %>
                <%= form.text_field :title, required: true, class: "form-input", id: "book_title" %>
            </div>

            <div class="form-group">
                <%= form.label :author, "è‘—è€…", class: "form-label" %>
                <%= form.text_field :author, class: "form-input", id: "book_author" %>
            </div>

            <div class="form-group">
                <%= form.label :publisher, "å‡ºç‰ˆç¤¾", class: "form-label" %>
                <%= form.text_field :publisher, class: "form-input", id: "book_publisher" %>
            </div>

            <div class="form-group">
                <%= form.label :cover_image_url, "è¡¨ç´™ç”»åƒURL", class: "form-label" %>
                <%= form.url_field :cover_image_url, class: "form-input", id: "book_cover_image_url" %>
            </div>

            <div class="form-group">
                <%= form.label :rating, "è©•ä¾¡", class: "form-label" %>
                <%= form.select :rating, options_for_select([
            ['æœªè©•ä¾¡', nil],
            ['â˜…â˜†â˜†â˜†â˜† (1)', 1],
            ['â˜…â˜…â˜†â˜†â˜† (2)', 2],
            ['â˜…â˜…â˜…â˜†â˜† (3)', 3],
            ['â˜…â˜…â˜…â˜…â˜† (4)', 4],
            ['â˜…â˜…â˜…â˜…â˜… (5)', 5]
          ]), {}, { class: "form-select" } %>
            </div>

            <div class="form-group">
                <%= form.label :memo, "ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³", class: "form-label" %>
                <%= form.text_area :memo, rows: 6, placeholder: "èª­ã‚“ã æ„Ÿæƒ³ã‚„å°è±¡ã«æ®‹ã£ãŸéƒ¨åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†", class: "form-textarea" %>
            </div>

            <div class="form-actions">
                <%= form.submit "ä¿å­˜", class: "submit-button primary" %>
                <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", books_path, class: "submit-button secondary" %>
            </div>
            <% end %>
        </div>
    </div>
</div>

<script>
    (function() {
        'use strict';

        window.BookSearch = {
            currentQuery: '',
            currentPage: 1,
            totalPages: 0,
            isLoading: false,

            async search(page = 1) {
                const query = document.getElementById('search-input').value.trim();
                const resultsDiv = document.getElementById('search-results');
                const paginationDiv = document.getElementById('search-pagination');
                const paginationInfo = document.getElementById('pagination-info');

                if (!query) {
                    resultsDiv.innerHTML = '<div class="search-empty">æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>';
                    paginationDiv.style.display = 'none';
                    paginationInfo.style.display = 'none';
                    return;
                }

                if (this.isLoading) return;

                this.isLoading = true;
                this.currentQuery = query;
                this.currentPage = page;

                const startIndex = (page - 1) * 10;

                resultsDiv.innerHTML = '<div class="search-loading">æ¤œç´¢ä¸­...</div>';
                paginationDiv.style.display = 'none';
                paginationInfo.style.display = 'none';

                try {
                    const response = await fetch(`/books/search_external?query=${encodeURIComponent(query)}&start_index=${startIndex}`);
                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.error);
                    }

                    if (data.items.length > 0) {
                        this.displayResults(data.items);
                        this.displayPagination(data.pagination);
                        this.displayPaginationInfo(data.pagination);
                    } else {
                        resultsDiv.innerHTML = '<div class="search-empty">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
                        paginationDiv.style.display = 'none';
                        paginationInfo.style.display = 'none';
                    }
                } catch (error) {
                    resultsDiv.innerHTML = `<div class="search-error">æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</div>`;
                    paginationDiv.style.display = 'none';
                    paginationInfo.style.display = 'none';
                } finally {
                    this.isLoading = false;
                }
            },

            displayResults(books) {
                const resultsDiv = document.getElementById('search-results');
                let html = '';

                books.forEach(book => {
                    const hasImage = book.cover_image && book.cover_image !== '';
                    html += `
          <div class="search-result-card" onclick="BookSearch.selectBook('${this.escapeHtml(book.title)}', '${this.escapeHtml(book.authors)}', '${this.escapeHtml(book.publisher)}', '${this.escapeHtml(book.cover_image || '')}')">
            <div class="result-cover">
              ${hasImage ? 
                `<img src="${book.cover_image}" alt="${this.escapeHtml(book.title)}" class="result-image">` : 
                `<div class="result-placeholder">ğŸ“–</div>`
              }
            </div>
            <div class="result-info">
              <h3 class="result-title">${this.escapeHtml(book.title)}</h3>
              <p class="result-author">${this.escapeHtml(book.authors)}</p>
              <p class="result-publisher">${this.escapeHtml(book.publisher)}</p>
            </div>
          </div>
        `;
                });

                resultsDiv.innerHTML = html;
            },

            displayPagination(pagination) {
                const paginationDiv = document.getElementById('search-pagination');
                const currentPage = pagination.current_page;
                const totalPages = pagination.total_pages;

                if (totalPages <= 1) {
                    paginationDiv.style.display = 'none';
                    return;
                }

                let html = '';

                if (pagination.has_prev) {
                    html += `<button class="pagination-button" onclick="BookSearch.search(${currentPage - 1})">å‰ã¸</button>`;
                }

                for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                    if (i === currentPage) {
                        html += `<button class="pagination-button active">${i}</button>`;
                    } else {
                        html += `<button class="pagination-button" onclick="BookSearch.search(${i})">${i}</button>`;
                    }
                }

                if (pagination.has_next) {
                    html += `<button class="pagination-button" onclick="BookSearch.search(${currentPage + 1})">æ¬¡ã¸</button>`;
                }

                paginationDiv.innerHTML = html;
                paginationDiv.style.display = 'flex';
            },

            displayPaginationInfo(pagination) {
                const paginationInfo = document.getElementById('pagination-info');

                if (pagination.total_items === 0) {
                    paginationInfo.style.display = 'none';
                    return;
                }

                const startItem = pagination.start_index + 1;
                const endItem = Math.min(pagination.start_index + 10, pagination.total_items);

                paginationInfo.innerHTML = `${startItem}ã€œ${endItem}ä»¶ / å…¨${pagination.total_items}ä»¶`;
                paginationInfo.style.display = 'block';
            },

            selectBook(title, authors, publisher, coverImage) {
                document.getElementById('book_title').value = title;
                document.getElementById('book_author').value = authors;
                document.getElementById('book_publisher').value = publisher;
                document.getElementById('book_cover_image_url').value = coverImage;

                document.getElementById('book_title').scrollIntoView({
                    behavior: 'smooth'
                });

                const message = document.createElement('div');
                message.innerHTML = 'âœ… æœ¬ãŒé¸æŠã•ã‚Œã¾ã—ãŸ';
                message.className = 'selection-message';
                document.body.appendChild(message);

                setTimeout(() => {
                    message.remove();
                }, 3000);
            },

            searchExample(query) {
                document.getElementById('search-input').value = query;
                this.search(1);
            },

            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢
        document.getElementById('search-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                BookSearch.search(1);
            }
        });
    })();
</script>