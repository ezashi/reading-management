<% content_for :title, "æœ¬ã‚’è¿½åŠ " %>

<div class="form-container">
    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div style="margin-bottom: 1rem;">
        <%= link_to books_path, class: "btn btn-secondary" do %>
        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd" />
        </svg>
        æˆ»ã‚‹
        <% end %>
    </div>

    <h1 class="form-title">æœ¬ã‚’è¿½åŠ </h1>

    <!-- å¤–éƒ¨æ¤œç´¢ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="external-search">
        <h2 class="external-search-title">æœ¬ã‚’æ¤œç´¢</h2>

        <!-- æ¤œç´¢ã®ãƒ’ãƒ³ãƒˆ -->
        <div style="background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 0.5rem; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.875rem; color: #1e40af;">
            <strong>ğŸ’¡ æ¤œç´¢ã®ã‚³ãƒ„:</strong>
            <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                <li>ã€Œ"Harry Potter"ã€ã®ã‚ˆã†ã«å¼•ç”¨ç¬¦ã§å›²ã‚€ã¨å®Œå…¨ä¸€è‡´æ¤œç´¢</li>
                <li>ã€Œæ‘ä¸Šæ˜¥æ¨¹ ãƒãƒ«ã‚¦ã‚§ã‚¤ã€ã®ã‚ˆã†ã«è‘—è€…åã¨ä½œå“åã‚’çµ„ã¿åˆã‚ã›ã‚‹</li>
                <li>ã€ŒRuby ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã€ã®ã‚ˆã†ã«ã‚¸ãƒ£ãƒ³ãƒ«ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’çµ„ã¿åˆã‚ã›ã‚‹</li>
            </ul>
        </div>

        <div class="external-search-form">
            <input type="text" id="search-input" placeholder="ä¾‹: &quot;ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼&quot;ã€æ‘ä¸Šæ˜¥æ¨¹ã€Ruby ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°" class="external-search-input">
            <button onclick="safeSearch(1)" class="btn btn-primary">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                </svg>
                æ¤œç´¢
            </button>
        </div>

        <!-- äººæ°—æ¤œç´¢ä¾‹ -->
        <div style="margin-bottom: 1rem;">
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 0.5rem;">äººæ°—ã®æ¤œç´¢ä¾‹:</p>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <button onclick="searchExample('&quot;ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼&quot;')" class="search-example-btn">ãƒãƒªãƒ¼ãƒ»ãƒãƒƒã‚¿ãƒ¼</button>
                <button onclick="searchExample('æ‘ä¸Šæ˜¥æ¨¹')" class="search-example-btn">æ‘ä¸Šæ˜¥æ¨¹</button>
                <button onclick="searchExample('&quot;é¬¼æ»…ã®åˆƒ&quot;')" class="search-example-btn">é¬¼æ»…ã®åˆƒ</button>
                <button onclick="searchExample('Python ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°')" class="search-example-btn">Pythonå…¥é–€</button>
                <button onclick="searchExample('æ±é‡åœ­å¾')" class="search-example-btn">æ±é‡åœ­å¾</button>
            </div>
        </div>

        <!-- æ¤œç´¢çµæœã‚’ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        <div class="search-results-container">
            <div id="search-results" class="search-results"></div>
            <div id="search-pagination" class="pagination" style="display: none;"></div>
            <div id="pagination-info" class="pagination-info" style="display: none;"></div>
        </div>
    </div>

    <!-- æ‰‹å‹•å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div style="background: white; border-radius: 1rem; padding: 1.5rem; border: 1px solid #e5e7eb;">
        <h2 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1.5rem; color: #1f2937;">æ‰‹å‹•ã§å…¥åŠ›</h2>

        <%= form_with model: @book, local: true do |form| %>
        <% if @book.errors.any? %>
        <div class="error-messages">
            <ul>
                <% @book.errors.full_messages.each do |message| %>
                <li><%= message %></li>
                <% end %>
            </ul>
        </div>
        <% end %>

        <div class="form-group">
            <%= form.label :title, "ã‚¿ã‚¤ãƒˆãƒ«", class: "form-label" %>
            <%= form.text_field :title, required: true, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :author, "è‘—è€…", class: "form-label" %>
            <%= form.text_field :author, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :publisher, "å‡ºç‰ˆç¤¾", class: "form-label" %>
            <%= form.text_field :publisher, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :cover_image_url, "è¡¨ç´™ç”»åƒURL", class: "form-label" %>
            <%= form.url_field :cover_image_url, class: "form-input" %>
        </div>

        <div class="form-group">
            <%= form.label :rating, "è©•ä¾¡", class: "form-label" %>
            <%= form.select :rating, options_for_select([
                    ['æœªè©•ä¾¡', nil],
                    ['â˜…â˜†â˜†â˜†â˜† (1)', 1],
                    ['â˜…â˜…â˜†â˜†â˜† (2)', 2],
                    ['â˜…â˜…â˜…â˜†â˜† (3)', 3],
                    ['â˜…â˜…â˜…â˜…â˜† (4)', 4],
                    ['â˜…â˜…â˜…â˜…â˜… (5)', 5]
                ]), {}, { class: "form-select" } %>
        </div>

        <div class="form-group">
            <%= form.label :memo, "ãƒ¡ãƒ¢ãƒ»æ„Ÿæƒ³", class: "form-label" %>
            <%= form.text_area :memo, rows: 6, placeholder: "èª­ã‚“ã æ„Ÿæƒ³ã‚„å°è±¡ã«æ®‹ã£ãŸéƒ¨åˆ†ã‚’è¨˜éŒ²ã—ã¾ã—ã‚‡ã†...", class: "form-textarea" %>
        </div>

        <div class="form-actions">
            <%= form.submit "ä¿å­˜", class: "btn btn-primary" %>
            <%= link_to "ã‚­ãƒ£ãƒ³ã‚»ãƒ«", books_path, class: "btn btn-secondary" %>
        </div>
        <% end %>
    </div>
</div>

<script>
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†
    (function() {
        'use strict';

        // BookSearchã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ç¢ºå®Ÿã«åˆæœŸåŒ–
        function initializeBookSearch() {
            window.BookSearch = {
                currentQuery: '',
                currentPage: 1,
                totalPages: 0,
                isLoading: false,
                initialized: true,

                async search(page = 1) {
                    console.log('=== BookSearch.search called ===');
                    const query = document.getElementById('search-input').value.trim();
                    const resultsDiv = document.getElementById('search-results');
                    const paginationDiv = document.getElementById('search-pagination');
                    const paginationInfo = document.getElementById('pagination-info');

                    console.log('Query:', query);

                    if (!query) {
                        resultsDiv.innerHTML = '<div class="search-results-empty"><div class="search-results-empty-icon">ğŸ”</div><p>æ¤œç´¢ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p></div>';
                        paginationDiv.style.display = 'none';
                        paginationInfo.style.display = 'none';
                        return;
                    }

                    if (this.isLoading) return;

                    this.isLoading = true;
                    this.currentQuery = query;
                    this.currentPage = page;

                    const startIndex = (page - 1) * 10;

                    resultsDiv.innerHTML = '<div class="search-results-loading"><div class="loading"><div class="loading-spinner"></div>æ¤œç´¢ä¸­...</div></div>';
                    paginationDiv.style.display = 'none';
                    paginationInfo.style.display = 'none';

                    try {
                        console.log('Fetching from API...');
                        const response = await fetch(`/books/search_external?query=${encodeURIComponent(query)}&start_index=${startIndex}`);
                        const data = await response.json();

                        console.log('API Response:', data);

                        if (data.items.length === 0 && page > 1) {
                            console.log('No results found for page', page, ', going back to page', page - 1);
                            this.search(page - 1);
                            return;
                        }

                        if (data.items.length === 0 && page === 1) {
                            resultsDiv.innerHTML = '<div class="search-results-empty"><div class="search-results-empty-icon">ğŸ“š</div><p>æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</p></div>';
                            paginationDiv.style.display = 'none';
                            paginationInfo.style.display = 'none';
                            return;
                        }

                        this.displayResults(data.items);
                        this.displayPagination(data.pagination);
                        this.displayPaginationInfo(data.pagination);

                    } catch (error) {
                        console.error('Search error:', error);
                        resultsDiv.innerHTML = '<div class="search-results-empty"><div class="search-results-empty-icon">âš ï¸</div><p>æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p></div>';
                        paginationDiv.style.display = 'none';
                        paginationInfo.style.display = 'none';
                    } finally {
                        this.isLoading = false;
                    }
                },

                displayResults(books) {
                    console.log('=== displayResults called ===');
                    console.log('Books data:', books);

                    const resultsDiv = document.getElementById('search-results');

                    if (books.length === 0) {
                        resultsDiv.innerHTML = '<div class="search-results-empty"><div class="search-results-empty-icon">ğŸ“š</div><p>ã“ã®ãƒšãƒ¼ã‚¸ã«çµæœãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
                        return;
                    }

                    let html = '';
                    const currentTime = Date.now();

                    books.forEach((book, index) => {
                        console.log(`Processing book ${index}:`, book);

                        // ç”»åƒãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
                        const hasValidImage = book.cover_image &&
                            book.cover_image !== '' &&
                            book.cover_image !== 'null' &&
                            book.cover_image !== 'undefined';

                        console.log(`Book ${index} has valid image:`, hasValidImage);

                        // å„æœ¬ã«ä¸€æ„ã®IDã‚’å‰²ã‚Šå½“ã¦
                        const bookId = `book-${index}-${currentTime}`;

                        html += `
                            <div class="search-result" onclick="window.BookSearch.selectBook('${this.escapeHtml(book.title)}', '${this.escapeHtml(book.authors)}', '${this.escapeHtml(book.publisher)}', '${this.escapeHtml(book.cover_image || '')}')">
                                <div class="search-result-content">
                                    <div class="search-result-cover" id="cover-${bookId}">
                                        ${hasValidImage ? 
                                            `<div class="image-container" style="position: relative; width: 60px; height: 80px;">
                                                <img id="img-${bookId}"
                                                     src="${book.cover_image}" 
                                                     alt="${this.escapeHtml(book.title)}" 
                                                     style="width: 60px; height: 80px; object-fit: cover; border-radius: 4px; display: block;"
                                                     onload="window.BookSearch.handleImageLoad('${bookId}', '${this.escapeHtml(book.title)}')"
                                                     onerror="window.BookSearch.handleImageError('${bookId}', '${this.escapeHtml(book.title)}')">
                                                <div id="fallback-${bookId}" 
                                                     style="position: absolute; top: 0; left: 0; width: 60px; height: 80px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 4px; display: none; justify-content: center; align-items: center; color: white; font-size: 1.5rem;">ğŸ“–</div>
                                                <div id="loading-${bookId}"
                                                     style="position: absolute; top: 0; left: 0; width: 60px; height: 80px; background: #f3f4f6; border-radius: 4px; display: flex; justify-content: center; align-items: center; color: #6b7280; font-size: 1rem;">â³</div>
                                            </div>` : 
                                            `<div style="width: 60px; height: 80px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border-radius: 4px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">ğŸ“–</div>`
                                        }
                                    </div>
                                    <div class="search-result-info">
                                        <h3 class="search-result-title">${this.escapeHtml(book.title)}</h3>
                                        <p class="search-result-author">è‘—è€…: ${this.escapeHtml(book.authors)}</p>
                                        <p class="search-result-publisher">å‡ºç‰ˆç¤¾: ${this.escapeHtml(book.publisher)}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    console.log('Setting innerHTML with HTML length:', html.length);
                    resultsDiv.innerHTML = html;

                    // ç”»åƒã®èª­ã¿è¾¼ã¿ç®¡ç†
                    this.manageImageLoading(books, currentTime);
                },

                manageImageLoading(books, currentTime) {
                    books.forEach((book, index) => {
                        if (book.cover_image && book.cover_image !== '') {
                            const bookId = `book-${index}-${currentTime}`;

                            // 3ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è¡¨ç¤º
                            setTimeout(() => {
                                const img = document.getElementById(`img-${bookId}`);
                                const loading = document.getElementById(`loading-${bookId}`);

                                if (img && !img.complete) {
                                    console.warn(`â° Image timeout for: ${book.title}`);
                                    this.handleImageError(bookId, book.title);
                                } else if (loading && loading.style.display !== 'none') {
                                    // ã¾ã ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã®å ´åˆ
                                    this.handleImageError(bookId, book.title);
                                }
                            }, 3000);
                        }
                    });
                },

                handleImageLoad(bookId, bookTitle) {
                    console.log(`âœ… Image loaded successfully for: ${bookTitle}`);
                    const loading = document.getElementById(`loading-${bookId}`);
                    if (loading) {
                        loading.style.display = 'none';
                    }
                },

                handleImageError(bookId, bookTitle) {
                    console.error(`âŒ Image failed for: ${bookTitle}`);
                    const img = document.getElementById(`img-${bookId}`);
                    const fallback = document.getElementById(`fallback-${bookId}`);
                    const loading = document.getElementById(`loading-${bookId}`);

                    if (img) img.style.display = 'none';
                    if (loading) loading.style.display = 'none';
                    if (fallback) fallback.style.display = 'flex';
                },

                displayPagination(pagination) {
                    const paginationDiv = document.getElementById('search-pagination');

                    if (pagination.total_pages <= 1) {
                        paginationDiv.style.display = 'none';
                        return;
                    }

                    let html = '';

                    if (pagination.has_prev) {
                        html += `<button class="pagination-btn pagination-btn-prev" onclick="safeSearch(${pagination.current_page - 1})">å‰ã¸</button>`;
                    } else {
                        html += `<button class="pagination-btn pagination-btn-prev" disabled>å‰ã¸</button>`;
                    }

                    for (let i = 1; i <= Math.min(pagination.total_pages, 5); i++) {
                        if (i === pagination.current_page) {
                            html += `<button class="pagination-btn active">${i}</button>`;
                        } else {
                            html += `<button class="pagination-btn" onclick="safeSearch(${i})">${i}</button>`;
                        }
                    }

                    if (pagination.has_next) {
                        html += `<button class="pagination-btn pagination-btn-next" onclick="safeSearch(${pagination.current_page + 1})">æ¬¡ã¸</button>`;
                    } else {
                        html += `<button class="pagination-btn pagination-btn-next" disabled>æ¬¡ã¸</button>`;
                    }

                    paginationDiv.innerHTML = html;
                    paginationDiv.style.display = 'flex';
                },

                displayPaginationInfo(pagination) {
                    const paginationInfo = document.getElementById('pagination-info');

                    if (pagination.total_items === 0) {
                        paginationInfo.style.display = 'none';
                        return;
                    }

                    const startItem = pagination.start_index + 1;
                    const endItem = Math.min(pagination.start_index + pagination.items_per_page, pagination.total_items);

                    paginationInfo.innerHTML = `${startItem}ã€œ${endItem}ä»¶ / å…¨${pagination.total_items}ä»¶`;
                    paginationInfo.style.display = 'block';
                },

                selectBook(title, authors, publisher, coverImage) {
                    console.log('selectBook called with:', {
                        title,
                        authors,
                        publisher,
                        coverImage
                    });

                    document.getElementById('book_title').value = title;
                    document.getElementById('book_author').value = authors;
                    document.getElementById('book_publisher').value = publisher;
                    document.getElementById('book_cover_image_url').value = coverImage;

                    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
                    document.getElementById('book_title').scrollIntoView({
                        behavior: 'smooth'
                    });

                    // é¸æŠã—ãŸã“ã¨ã‚’è¦–è¦šçš„ã«ç¤ºã™
                    const selectedMessage = document.createElement('div');
                    selectedMessage.innerHTML = 'âœ… æœ¬ãŒé¸æŠã•ã‚Œã¾ã—ãŸ';
                    selectedMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #10b981; color: white; padding: 12px 20px; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                    document.body.appendChild(selectedMessage);

                    setTimeout(() => {
                        selectedMessage.remove();
                    }, 3000);
                },

                escapeHtml(text) {
                    if (!text) return '';
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            };

            console.log('BookSearch initialized:', window.BookSearch.initialized);
        }

        // å®‰å…¨ãªæ¤œç´¢é–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ï¼‰
        window.safeSearch = function(page = 1) {
            if (window.BookSearch && window.BookSearch.initialized) {
                window.BookSearch.search(page);
            } else {
                console.error('BookSearch not initialized yet');
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œ
                setTimeout(() => {
                    if (window.BookSearch && window.BookSearch.initialized) {
                        window.BookSearch.search(page);
                    } else {
                        alert('æ¤œç´¢æ©Ÿèƒ½ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    }
                }, 100);
            }
        };

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦åˆæœŸåŒ–
        function initialize() {
            if (document.readyState === 'loading') {
                // ã¾ã èª­ã¿è¾¼ã¿ä¸­
                document.addEventListener('DOMContentLoaded', initializeBookSearch);
            } else {
                // æ—¢ã«èª­ã¿è¾¼ã¿å®Œäº†
                initializeBookSearch();
            }

            // å¿µã®ãŸã‚ã€windowã®loadã‚¤ãƒ™ãƒ³ãƒˆã§ã‚‚åˆæœŸåŒ–
            window.addEventListener('load', function() {
                if (!window.BookSearch || !window.BookSearch.initialized) {
                    initializeBookSearch();
                }
            });
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        function setupEventListeners() {
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
                searchInput.removeEventListener('keypress', handleKeyPress);
                searchInput.removeEventListener('input', handleInput);

                // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
                searchInput.addEventListener('keypress', handleKeyPress);
                searchInput.addEventListener('input', handleInput);
            } else {
                // è¦ç´ ãŒã¾ã ãªã„å ´åˆã¯å°‘ã—å¾…ã£ã¦å†è©¦è¡Œ
                setTimeout(setupEventListeners, 100);
            }
        }

        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                safeSearch(1);
            }
        }

        function handleInput(e) {
            if (e.target.value.trim() === '') {
                const resultsDiv = document.getElementById('search-results');
                const paginationDiv = document.getElementById('search-pagination');
                const paginationInfo = document.getElementById('pagination-info');

                if (resultsDiv) resultsDiv.innerHTML = '';
                if (paginationDiv) paginationDiv.style.display = 'none';
                if (paginationInfo) paginationInfo.style.display = 'none';
            }
        }

        // åˆæœŸåŒ–ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’å®Ÿè¡Œ
        initialize();

        // DOMContentLoadedã§ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupEventListeners);
        } else {
            setupEventListeners();
        }

        function searchExample(exampleQuery) {
            const searchInput = document.getElementById('search-input');
            searchInput.value = exampleQuery;
            safeSearch(1);
        }

    })();
</script>